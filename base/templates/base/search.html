{% extends 'base.html' %}

{% load static %}

{% block css_files %}
{% endblock %}

{% block page_title %}
    Search Results
{% endblock %}

{% block content %}
    <div class="container freepage">
        <div class="row mt-3">
            <!-- Search Bar -->
            <div class="col-12 mb-3">
                <form id="search-form">
                    <div class="input-group">
                        <input type="text" id="custom-url" class="form-control" placeholder="Enter custom URL">
                        <div class="input-group-append">
                            <button id="search-button" class="btn btn-primary" type="button">Search</button>
                        </div>
                    </div>
                </form>
            </div>

            {% if news_items %}
                {% for item in news_items.entries %}
                    <div class="col-md-4 mb-3">
                        <a href="{{ item.link }}" class="card-link">
                            <div class="card">
                                {% if item.image and item.image.url %}
                                    <img src="{{ item.image.url }}" class="card-img-top" alt="{{ item.title }}">
                                {% endif %}
                                <div class="card-body">
                                    <h5 class="card-title" style="color: red">{{ item.title }}</h5>
                                    <p class="card-text">{{ item.description|truncatechars:100|safe }}</p>
                                    <p class="card-text"><small class="text-muted">{{ item.time }}</small></p>
                                </div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <p>No news items found.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        document.getElementById('search-button').addEventListener('click', function () {
            const customUrl = document.getElementById('custom-url').value;
            if (customUrl) {
                
                fetch(`http://localhost:8000/api/secure_api/?custom_url=${customUrl}`)
                    .then(response => response.json())
                    .then(data => {
                        // Check if data is valid and update the page
                        if (data.entries) {
                            const newsItemsContainer = document.querySelector('.row.mt-3');
                            newsItemsContainer.innerHTML = ''; // Clear existing news items
                            data.entries.forEach(item => {
                                const cardDiv = document.createElement('div');
                                cardDiv.classList.add('col-md-4', 'mb-3');

                                const cardLink = document.createElement('a');
                                cardLink.classList.add('card-link');
                                cardLink.href = item.link;

                                const card = document.createElement('div');
                                card.classList.add('card');

                                if (item.image && item.image.url) {
                                    const cardImg = document.createElement('img');
                                    cardImg.classList.add('card-img-top');
                                    cardImg.src = item.image.url;
                                    cardImg.alt = item.title;
                                    card.appendChild(cardImg);
                                }

                                const cardBody = document.createElement('div');
                                cardBody.classList.add('card-body');

                                const cardTitle = document.createElement('h5');
                                cardTitle.classList.add('card-title');
                                cardTitle.style.color = 'red';
                                cardTitle.textContent = item.title;
                                cardBody.appendChild(cardTitle);

                                const cardText = document.createElement('p');
                                cardText.classList.add('card-text');
                                cardText.innerHTML = `${item.description.slice(0, 100)}...`;
                                cardBody.appendChild(cardText);

                                const cardTimestamp = document.createElement('p');
                                cardTimestamp.classList.add('card-text');
                                cardTimestamp.innerHTML = `<small class="text-muted">${item.time}</small>`;
                                cardBody.appendChild(cardTimestamp);

                                card.appendChild(cardBody);
                                cardLink.appendChild(card);
                                cardDiv.appendChild(cardLink);
                                newsItemsContainer.appendChild(cardDiv);
                            });
                        } else {
                            const newsItemsContainer = document.querySelector('.row.mt-3');
                            newsItemsContainer.innerHTML = '<div class="col-12"><p>No news items found.</p></div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error.message);
                    });
            }
        });
    </script>
{% endblock %}
